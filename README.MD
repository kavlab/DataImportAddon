# Инструкция по использованию аддона DataImport

После подключения аддона в проект будет добавлен пункт меню «Data import settings» в группу «Data tools».  
<img src="/docs/img/01.png" width="40%" />

Настройка и использование аддона разделено на 3 шага.

## Первый шаг – параметры подключения к базе 1С

На первом шаге настройки импорта данных необходимо задать параметры доступа к базе 1С:Предприятия на веб\-сервере \- URL опубликованной базы в формате https://\<адрес и порт веб\-сервера\>/\<имя публикации\>, а также имя пользователя и его пароль. Пользователь, параметры которого указаны, должен иметь права на чтение всех объектов, которые доступны через интерфейс OData.  
<img src="/docs/img/02.png" width="100%" />

После ввода параметров необходимо нажать кнопку «Connect to the database and extract metadata». При нажатии на эту кнопку происходит подключение к стандартному интерфейсу OData базы 1С:Предприятия и, в случае успешного подключения, выполняется извлечение опубликованных через OData метаданных. В случае возникновения ошибки, сообщение об этом будет выведено на экран. Тогда нужно будет проверить параметры публикации базы 1С, она должна быть опубликована с включенным OData-провайдером.  
Кнопка «Next» доступна только в том случае, когда подключение пройдет без ошибок. По нажатию на эту кнопку отобразится панель второго этапа настроек. Также переход на второй этап будет выполнен автоматически в случае успешного подключения и извлечения метаданных.

## Второй шаг – настройка соответствия сущностей Jmix и 1С

На втором шаге отображается таблица, в которую выводится список всех JPA-сущностей Jmix.  
<img src="/docs/img/03.png" width="100%" />

В колонке «Upload» устанавливается признак загрузки. По умолчанию он снят, чтобы исключить случайную загрузку данных.  
Колонка «Jmix» содержит наименование сущности Jmix. Колонка «1С» – наименование выбранной для загрузки сущности 1С (в том виде как она именуется в стандартном интерфейсе OData в 1С:Предприятии).  
Колонки «Attributes mapped» и «Script defined» отображают состояние настроек соответствия атрибутов и наличие Groovy скрипта для специальной загрузки данных.  
<img src="/docs/img/04.png" width="100%" />

### Установка соответствий сущностей Jmix и 1С

По кнопке «1C entity» открывается диалоговое окно выбора соответствующей сущности 1С:  
<img src="/docs/img/05.png" width="50%" />

Здесь выводятся все сущности 1С, доступ к которым был открыт через стандартный интерфейс OData. Настройка доступа к метаданным 1С выполняется с помощью процедуры «УстановитьСоставСтандартногоИнтерфейсаOData» в коде 1С:Предприятие, например таким образом:  
<img src="/docs/img/06.png" width="100%" />

Для сущностей Jmix, у которых не выбрано соответствие сущности 1С, загрузка выполняться не будет.

### Установка соответствий свойств сущностей Jmix и 1С

По кнопке «attributes» будет открыто диалоговое окно для задания соответствий свойств сущностей Jmix и 1С:  
<img src="/docs/img/07.png" width="100%" />

В колонке «Jmix attribute» выводятся свойства сущности Jmix, в колонке «Type» выбирается тип соответствия из двух возможных вариантов: «Constant» и «Attribute».  
<img src="/docs/img/08.png" width="40%" />

Тип «Constant» доступен только для свойств с типом String. А тип «Attribute» доступен для всех свойств.  
При выборе «Constant» можно задать значение, которое будет установлено у всех загруженных объектов.  
В случае выбора «Attribute» в поле, которое отобразится правее, нужно выбрать свойство сущности 1С, из которого будут считываться значения при импорте данных. Типы данных 1С во время импорта автоматически конвертируются в типы данных Jmix.  
Если не задать соответствие свойств для сущностей Jmix и 1С, то при загрузке будут созданы новые объекты, но их свойства не будут заполнены (кроме Id).

### Установка скрипта

Для тонкой настройки загрузки данных в аддоне имеется возможность задать Groovy скрипт для обработки загружаемых объектов. В скрипте доступны следующие переменные:

* newEntity
* externalProperties
* skipEntity

«newEntity» – это загружаемый объект, его тип «Object».  
Тип переменной «externalProperties» – «Map\<String, Object\>». Эта переменная содержит значения свойств объекта 1С. Ключи Map совпадают с именами свойств сущностей 1С, которые можно выбрать при установке соответствий по кнопке «attributes».  
Переменную «skipEntity» можно использовать для фильтрации загружаемых данных. Например, при загрузке из справочника 1С с иерархией групп и элементов, скорее всего потребуется загрузка только элементов без групп. Это можно будет сделать с помощью такого скрипта:  
<img src="/docs/img/09.png" width="100%" />

Во время загрузки для объектов 1С, у которых стоит признак «IsFolder» («ЭтоГруппа» в русском варианте кода 1С), значение «skipEntity» будет установлено в истину, и этот объект не будет загружен.

## Третий шаг – сохранение и загрузка настроек, дополнительные параметры

На третьем шаге выводятся сериализованные в JSON настройки соответствий сущностей, атрибутов и скриптов. Здесь же можно сохранить их в файл (кнопка «Save to file») или загрузить ранее сохраненные настройки (кнопка «Load from file…»).  
<img src="/docs/img/10.png" width="75%" />

На вкладке «Advanced import settings» можно задать дополнительные настройки: размер порции загружаемых данных (сколько объектов будет прочитано за один запрос из базы 1С) и поведение при возникновении ошибки (прервать загрузку или игнорировать ошибку).  
<img src="/docs/img/11.png" width="75%" />

<img src="/docs/img/12.png" width="50%" />

После того, как будут заданы все настройки импорта, можно приступить непосредственно к загрузке данных. Запуск процесса загрузки выполняется кнопкой «Start importing». Загружаться будут только те данных, у которых в строках таблицы второго шага установлен признак «Upload». При повторной загрузке все объекты будут создаваться заново без поиска ранее загруженных данных.  
В процессе импорта данных в диалоговом окне будет отображаться прогресс загрузки.
<img src="/docs/img/13.png" width="50%" />

После завершения импорта данных будет выведено информационное сообщение.
